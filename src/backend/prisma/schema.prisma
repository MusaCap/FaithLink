generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String     @id @default(cuid())
  email      String     @unique
  password   String
  createdAt  DateTime   @default(now())
  isActive   Boolean    @default(true)
  updatedAt  DateTime   @updatedAt
  role       String     @default("MEMBER")
  churchId   String?
  careLogs   CareLog[]  @relation("CareGiver")
  member     Member?
  activities Activity[]

  @@map("users")
}

model Member {
  id                 String               @id @default(cuid())
  userId             String?              @unique
  memberNumber       String?              @unique // Unique member number for financial system integration
  firstName          String
  lastName           String
  email              String               @unique
  phone              String?
  dateOfBirth        DateTime?
  gender             String?
  address            String?
  maritalStatus      String?
  spiritualStatus    String?
  profilePhotoUrl    String?
  notes              String?
  isActive           Boolean              @default(true)
  churchId           String?
  membershipStatus   String?              @default("pending")
  role               String?              @default("member")
  deaconId           String?              // Assigned deacon for pastoral care
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  careLogs           CareLog[]
  eventAttendances   EventAttendance[]
  groups             GroupMember[]
  journeyStages      JourneyStage[]
  familyConnections  MemberFamily[]       @relation("MemberFamily")
  relatedConnections MemberFamily[]       @relation("RelatedMember")
  tags               MemberTag[]
  prayerRequests     PrayerRequest[]
  counselingSessions CounselingSession[]
  activities         Activity[]
  church             Church?              @relation("ChurchMembers", fields: [churchId], references: [id])
  user               User?                @relation(fields: [userId], references: [id])
  volunteer          Volunteer?           // One-to-one relationship with volunteer profile
  coordinatedOpportunities VolunteerOpportunity[] @relation("OpportunityCoordinator")
  assignedDeacon     Deacon?              @relation("DeaconMembers", fields: [deaconId], references: [id])
  deaconProfile      Deacon?              @relation("DeaconMemberProfile") // If this member is also a deacon

  @@map("members")
}

model Deacon {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  email       String   @unique
  phone       String?
  isActive    Boolean  @default(true)
  churchId    String?
  memberId    String?  @unique // Optional link to member profile if deacon is also a member
  
  // Deacon-specific fields
  ordainedDate DateTime?
  specialties  String[] // Areas of specialty (counseling, youth, seniors, etc.)
  maxMembers   Int?     // Maximum number of members they can handle
  notes        String?
  
  // Relationships
  assignedMembers Member[] @relation("DeaconMembers")
  church          Church?  @relation("ChurchDeacons", fields: [churchId], references: [id])
  member          Member?  @relation("DeaconMemberProfile", fields: [memberId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("deacons")
}

model Group {
  id          String        @id @default(cuid())
  name        String
  type        String
  description String?
  leaderId    String?
  churchId    String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  events      Event[]
  files       GroupFile[]
  members     GroupMember[]
  church      Church?       @relation("ChurchGroups", fields: [churchId], references: [id])

  @@map("groups")
}

model GroupMember {
  id       String   @id @default(cuid())
  memberId String
  groupId  String
  joinedAt DateTime @default(now())
  isActive Boolean  @default(true)
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  member   Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, groupId])
  @@map("group_members")
}

model JourneyTemplate {
  id            String         @id @default(cuid())
  name          String
  description   String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  journeyStages JourneyStage[]
  milestones    Milestone[]

  @@map("journey_templates")
}

model Milestone {
  id            String          @id @default(cuid())
  templateId    String
  name          String
  description   String?
  sequence      Int
  journeyStages JourneyStage[]
  template      JourneyTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, sequence])
  @@map("milestones")
}

model JourneyStage {
  id              String          @id @default(cuid())
  memberId        String
  templateId      String
  milestoneId     String
  status          String          @default("NOT_STARTED")
  autoProgress    Boolean         @default(false)
  flagForFollowUp Boolean         @default(false)
  completedAt     DateTime?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  member          Member          @relation(fields: [memberId], references: [id], onDelete: Cascade)
  milestone       Milestone       @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  template        JourneyTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([memberId, milestoneId])
  @@map("journey_stages")
}

model Event {
  id           String            @id @default(cuid())
  title        String
  description  String?
  dateTime     DateTime
  location     String?
  groupId      String?
  churchId     String?
  calendarType String            @default("ONEOFF")
  createdBy    String
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  attendances  EventAttendance[]
  tags         EventTag[]
  group        Group?            @relation(fields: [groupId], references: [id])
  church       Church?           @relation("ChurchEvents", fields: [churchId], references: [id])

  @@map("events")
}

model EventAttendance {
  id          String    @id @default(cuid())
  eventId     String
  memberId    String
  attended    Boolean   @default(false)
  checkedInAt DateTime?
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  member      Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([eventId, memberId])
  @@map("event_attendances")
}

model CareLog {
  id               String    @id @default(cuid())
  memberId         String
  caregiverId      String
  type             String
  notes            String
  followUpRequired Boolean   @default(false)
  confidential     Boolean   @default(false)
  followUpDate     DateTime?
  createdAt        DateTime  @default(now())
  caregiver        User      @relation("CareGiver", fields: [caregiverId], references: [id])
  member           Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("care_logs")
}

model Tag {
  id        String      @id @default(cuid())
  label     String      @unique
  category  String      @default("MEMBER")
  color     String      @default("#7ED321")
  createdAt DateTime    @default(now())
  events    EventTag[]
  members   MemberTag[]

  @@map("tags")
}

model MemberTag {
  id       String @id @default(cuid())
  memberId String
  tagId    String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([memberId, tagId])
  @@map("member_tags")
}

model EventTag {
  id      String @id @default(cuid())
  eventId String
  tagId   String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([eventId, tagId])
  @@map("event_tags")
}

model GroupFile {
  id         String   @id @default(cuid())
  groupId    String
  fileName   String
  fileUrl    String
  fileSize   Int
  mimeType   String
  uploadedBy String
  uploadedAt DateTime @default(now())
  group      Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("group_files")
}

model MemberFamily {
  id            String @id @default(cuid())
  memberId      String
  relatedId     String
  relationship  String
  member        Member @relation("MemberFamily", fields: [memberId], references: [id], onDelete: Cascade)
  relatedMember Member @relation("RelatedMember", fields: [relatedId], references: [id], onDelete: Cascade)

  @@unique([memberId, relatedId])
  @@map("member_families")
}

model Church {
  id           String   @id @default(cuid())
  name         String
  description  String?
  address      String?
  city         String?
  state        String?
  zipCode      String?
  phone        String?
  email        String?
  website      String?
  denomination String?
  isPublic     Boolean  @default(true)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  members      Member[] @relation("ChurchMembers")
  groups       Group[]  @relation("ChurchGroups")
  events       Event[]  @relation("ChurchEvents")
  volunteerOpportunities VolunteerOpportunity[] @relation("ChurchVolunteerOpportunities")
  deacons      Deacon[] @relation("ChurchDeacons")

  @@map("churches")
}

model PrayerRequest {
  id              String          @id @default(cuid())
  title           String
  description     String
  requestedBy     String
  requestedByName String
  category        String          
  priority        String          @default("medium")
  status          String          @default("active")
  isPrivate       Boolean         @default(false)
  assignedTo      String?
  assignedBy      String?
  assignedAt      DateTime?
  prayerCount     Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  updates         PrayerUpdate[]
  member          Member          @relation(fields: [requestedBy], references: [id], onDelete: Cascade)

  @@map("prayer_requests")
}

model PrayerUpdate {
  id               String         @id @default(cuid())
  prayerRequestId  String
  content          String
  author           String
  createdAt        DateTime       @default(now())
  prayerRequest    PrayerRequest  @relation(fields: [prayerRequestId], references: [id], onDelete: Cascade)

  @@map("prayer_updates")
}

model BugReport {
  id               String    @id @default(cuid())
  title            String
  description      String
  steps            String?
  expectedBehavior String?
  actualBehavior   String?
  browserInfo      String?
  userEmail        String
  userId           String?
  churchId         String?
  churchName       String?
  severity         String    @default("medium")
  category         String    @default("general")
  status           String    @default("open")
  priority         String    @default("normal")
  submittedAt      DateTime  @default(now())
  reportedUrl      String?
  stackTrace       String?
  viewport         Json?
  platform         String?
  isAutomatic      Boolean   @default(false)
  resolvedAt       DateTime?
  resolvedBy       String?
  resolution       String?

  @@map("bug_reports")
}

model CounselingSession {
  id            String    @id @default(cuid())
  memberName    String
  counselorName String
  sessionType   String
  status        String    @default("scheduled")
  scheduledDate DateTime
  duration      Int       @default(60)
  notes         String?
  memberId      String?
  counselorId   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  member        Member?   @relation(fields: [memberId], references: [id])

  @@map("counseling_sessions")
}

model Activity {
  id          String   @id @default(cuid())
  type        String
  title       String
  description String?
  memberId    String?
  userId      String?
  metadata    Json?
  createdAt   DateTime @default(now())
  member      Member?  @relation(fields: [memberId], references: [id])
  user        User?    @relation(fields: [userId], references: [id])

  @@map("activities")
}

// VOLUNTEER MANAGEMENT MODELS

model Volunteer {
  id              String   @id @default(cuid())
  memberId        String   @unique
  member          Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  // Profile Information
  skills          String[] // Array of skills (e.g., ["music", "teaching", "childcare"])
  interests       String[] // Areas of interest
  availability    Json     // Weekly availability schedule
  maxHoursPerWeek Int?     // Time commitment limit
  
  // Preferences
  preferredMinistries String[] // Preferred ministry areas
  transportationAvailable Boolean @default(false)
  willingToTravel Boolean @default(false)
  
  // Status Tracking
  isActive        Boolean  @default(true)
  backgroundCheck BackgroundCheckStatus @default(NOT_REQUIRED)
  emergencyContact Json    // Emergency contact info
  notes           String?  // Coordinator notes
  
  // Relationships
  opportunities   VolunteerOpportunityAssignment[]
  signups         VolunteerSignup[]
  hours          VolunteerHour[]
  trainingCompletions VolunteerTrainingCompletion[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("volunteers")
}

model VolunteerOpportunity {
  id              String   @id @default(cuid())
  
  // Basic Information
  title           String
  description     String
  ministry        String   // Which ministry area
  location        String?
  contactEmail    String?
  contactPhone    String?
  
  // Requirements
  skillsRequired  String[] // Required skills
  minAge          Int?     // Minimum age requirement
  maxAge          Int?     // Maximum age requirement
  backgroundCheckRequired Boolean @default(false)
  trainingRequired String[] // Required training
  
  // Scheduling
  startDate       DateTime
  endDate         DateTime?
  isRecurring     Boolean  @default(false)
  recurringSchedule Json?   // Recurring schedule details
  estimatedHours  Float?   // Estimated hours per occurrence
  
  // Capacity
  maxVolunteers   Int?     // Capacity limit
  currentVolunteers Int   @default(0)
  
  // Status and Priority
  isActive        Boolean  @default(true)
  urgency         VolunteerPriority @default(NORMAL)
  status          OpportunityStatus @default(OPEN)
  
  // Relationships
  coordinator     Member   @relation("OpportunityCoordinator", fields: [coordinatorId], references: [id])
  coordinatorId   String
  church          Church?  @relation("ChurchVolunteerOpportunities", fields: [churchId], references: [id])
  churchId        String?
  
  volunteers      VolunteerOpportunityAssignment[]
  signups         VolunteerSignup[]
  hours          VolunteerHour[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("volunteer_opportunities")
}

model VolunteerOpportunityAssignment {
  id              String   @id @default(cuid())
  
  volunteerId     String
  volunteer       Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)
  opportunityId   String
  opportunity     VolunteerOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  
  // Assignment Details
  assignedBy      String   // Member ID who made the assignment
  assignedDate    DateTime @default(now())
  role            String?  // Specific role within the opportunity
  
  isActive        Boolean  @default(true)
  
  @@unique([volunteerId, opportunityId])
  @@map("volunteer_opportunity_assignments")
}

model VolunteerSignup {
  id              String   @id @default(cuid())
  
  volunteerId     String
  volunteer       Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)
  opportunityId   String
  opportunity     VolunteerOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  
  // Signup Details
  status          SignupStatus @default(PENDING)
  message         String?      // Message from volunteer
  specialRequests String?      // Special requests or accommodations
  
  // Scheduling
  scheduledDate   DateTime?
  scheduledStartTime DateTime?
  scheduledEndTime   DateTime?
  estimatedHours  Float?
  
  // Confirmation
  confirmedAt     DateTime?
  confirmedBy     String?      // Member ID who confirmed
  declinedAt      DateTime?
  declinedReason  String?
  
  // Completion
  completedAt     DateTime?
  actualHours     Float?
  feedback        String?      // Volunteer feedback
  rating          Int?         // 1-5 star rating
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([volunteerId, opportunityId, scheduledDate])
  @@map("volunteer_signups")
}

model VolunteerHour {
  id              String   @id @default(cuid())
  
  volunteerId     String
  volunteer       Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)
  opportunityId   String?
  opportunity     VolunteerOpportunity? @relation(fields: [opportunityId], references: [id])
  
  // Time Tracking
  date            DateTime
  startTime       DateTime?
  endTime         DateTime?
  hoursWorked     Float
  description     String
  
  // Categories
  category        String   // Type of volunteer work
  ministry        String?  // Ministry area
  
  // Verification
  isVerified      Boolean  @default(false)
  verifiedBy      String?  // Member ID who verified
  verifiedAt      DateTime?
  verificationNotes String?
  
  // Additional Info
  location        String?
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("volunteer_hours")
}

model VolunteerTraining {
  id              String   @id @default(cuid())
  
  // Training Information
  name            String
  description     String?
  category        String   // Training category
  isRequired      Boolean  @default(false)
  validityPeriod  Int?     // Months until expiration
  
  // Content
  materials       Json?    // Training materials/links
  requirements    String?  // Prerequisites
  estimatedDuration Int?   // Minutes
  
  // Status
  isActive        Boolean  @default(true)
  
  // Relationships
  completions     VolunteerTrainingCompletion[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("volunteer_trainings")
}

model VolunteerTrainingCompletion {
  id              String   @id @default(cuid())
  
  volunteerId     String
  volunteer       Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)
  trainingId      String
  training        VolunteerTraining @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  
  // Completion Details
  completedAt     DateTime
  expiresAt       DateTime?
  score           Float?   // If applicable
  notes           String?
  
  // Verification
  verifiedBy      String?  // Member ID who verified
  certificateUrl  String?  // Link to certificate
  
  createdAt       DateTime @default(now())
  
  @@unique([volunteerId, trainingId])
  @@map("volunteer_training_completions")
}

// ENUMS FOR VOLUNTEER SYSTEM

enum BackgroundCheckStatus {
  NOT_REQUIRED
  REQUIRED
  PENDING
  IN_PROGRESS
  APPROVED
  EXPIRED
  REJECTED
}

enum VolunteerPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum OpportunityStatus {
  DRAFT
  OPEN
  FILLED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum SignupStatus {
  PENDING
  CONFIRMED
  DECLINED
  WAITLISTED
  COMPLETED
  NO_SHOW
  CANCELLED
}

